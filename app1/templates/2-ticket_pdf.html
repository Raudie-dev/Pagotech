{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Comprobante PayZen #{{ liq_nro }}</title>
    <style>
        :root {
            --primary: #e63946;
            --dark: #000000;
            --grey: #4b5563;
            --light-grey: #f4f4f5;
            --soft-grey: #e5e7eb; 
        }

        @page {
            size: A4;
            margin: 0.8cm;
        }

        body {
            font-family: 'Helvetica', Arial, sans-serif;
            background-color: #fff;
            color: var(--dark);
            margin: 0;
            padding: 0;
            font-size: 8.5pt;
            line-height: 1.25;
        }

        /* LOGO BOX */
        .logo-box { 
            width: 105px; 
            height: 105px;
            display: table-cell;
            vertical-align: middle; 
            text-align: center;
            background-color: #fff;
        }
        .logo-box img {
            max-width: 100%;
            max-height: 100%;
            display: block;
            margin: 0 auto;
        }

        /* HEADER */
        .header-table { width: 100%; border-bottom: 2.5px solid var(--dark); padding-bottom: 12px; margin-bottom: 10px; }
        .fiscal-data { vertical-align: top; padding-left: 20px; }
        .resumen-title { font-size: 15pt; font-weight: 800; color: var(--primary); margin-bottom: 4px; text-transform: uppercase; }
        .fiscal-grid { width: 100%; border-collapse: collapse; font-size: 7.2pt; }
        .fiscal-grid td { padding: 1.5px 0; }
        .bold { font-weight: bold; }

        /* SECCIÓN TITULO BARRA */
        .primary-bar {
            background-color: var(--dark);
            color: #fff;
            padding: 8px 15px;
            text-align: right;
            font-size: 14pt;
            font-weight: bold;
            font-style: italic;
            border-right: 10px solid var(--primary);
            margin: 15px 0;
        }

        /* CONTENEDOR RAZÓN SOCIAL Y TOTALES */
        .summary-wrapper { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .client-info { width: 45%; vertical-align: top; padding: 10px; border-bottom: 1px solid var(--light-grey); }
        .totals-sidebar { width: 55%; padding-left: 35px; }
        
        .box-totals { width: 100%; border-bottom: 2px solid var(--dark); margin-bottom: 8px; }
        .box-totals th { text-align: left; font-size: 7.5pt; color: var(--grey); text-transform: uppercase; }
        .box-totals td { text-align: left; font-size: 12pt; font-weight: bold; padding: 3px 0; }
        .box-totals.saldo-accent { border-bottom: 4px solid var(--primary); }
        .text-red { color: var(--primary); }

        /* TABLA PRINCIPAL DE LIQUIDACIÓN */
        .liq-table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1.5px solid var(--dark); 
        }
        
        .liq-table thead th {
            background-color: var(--dark);
            color: #fff;
            padding: 10px 8px;
            font-size: 7.5pt;
            text-transform: uppercase;
            border-right: 1px solid #444;
        }

        .liq-table tbody td {
            padding: 12px 8px;
            vertical-align: top;
            font-size: 8pt;
            border-right: 1px solid var(--soft-grey);
        }

        .liq-table th:last-child, 
        .liq-table td:last-child {
            border-right: none;
        }

        /* FILA DE TOTALES UNIFORME */
        .total-row {
            background-color: var(--light-grey);
        }
        
        .total-row td {
            border-top: 1.5px solid var(--dark) !important;
            padding: 10px 8px;
            font-weight: bold;
            vertical-align: middle;
        }

        .desc-section { margin-bottom: 10px; }
        .val-num { float: right; font-weight: bold; color: var(--dark); }
        .sub-text { font-size: 7pt; color: var(--grey); font-style: italic; display: block; margin-top: 2px; }

        /* FOOTER */
        .tax-footer { width: 100%; border: 1.5px solid var(--dark); border-top: none; }
        .tax-footer td { padding: 10px; font-size: 7.5pt; background: #fafafa; }
        .final-row { width: 100%; margin-top: 25px; }
        .qr-cell { text-align: right; }
        .footer-brand { 
            text-align: center; 
            margin-top: 30px; 
            font-size: 7.2pt; 
            color: var(--grey); 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
        }
    </style>
</head>
<body>

    <!-- ENCABEZADO FISCAL CON ORIENTACIÓN PAYZEN -->
    <table class="header-table">
        <tr>
            <td width="115">
                <div class="logo-box">
                    <img src="{% static 'images/hero_payment.png' %}" alt="Logo Comprobante">
                </div>
            </td>
            <td class="fiscal-data">
                <div class="resumen-title">Comprobante de Liquidación PayZen</div>
                <table class="fiscal-grid">
                    <tr>
                        <td width="110" class="bold">FECHA DE PROCESO:</td>
                        <td width="135">{{ link.created_at|date:"d/m/Y H:i" }}</td>
                        <td width="110" class="bold">PLATAFORMA:</td>
                        <td>LYRA / PAYZEN REST API</td>
                    </tr>
                    <tr>
                        <td class="bold">MID (MERCHANT ID):</td>
                        <td>#{{ link.cliente.id|stringformat:"05d" }}</td>
                        <td class="bold">AUTORIZACIÓN:</td>
                        <td>{{ liq_nro }}</td>
                    </tr>
                    <tr>
                        <td class="bold">SITIO (URL):</td>
                        <td>PAYMENT.PAGOTECH.LA</td>
                        <td class="bold">ESTABLECIMIENTO:</td>
                        <td>0030767446</td>
                    </tr>
                    <tr>
                        <td class="bold">PROCESADOR:</td>
                        <td>SITEL / PAGO TECH</td>
                        <td class="bold">STATUS:</td>
                        <td class="bold">CAPTURED / AUTHORISED</td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>

    <div class="primary-bar">Reporte Consolidado de Pago Electrónico</div>

    <!-- RECEPTOR Y TOTALES -->
    <table class="summary-wrapper">
        <tr>
            <td class="client-info">
                <p class="bold" style="color: var(--grey); margin-bottom: 2px; font-size: 7.5pt;">RECEPTOR ASOCIADO</p>
                <p class="bold" style="font-size: 13pt; margin-top: 0; margin-bottom: 5px;">{{ link.cliente.nombre|upper }}</p>
                <p style="margin: 0; color: #333;">Merchant Email: {{ link.cliente.email }}</p>
                <p style="margin-top: 5px;" class="bold">GATEWAY INFO: 
                    {% if link.tipo_tarjeta == 'credito' %}CREDIT CARD - Lyra{% else %}DEBIT CARD - Lyra{% endif %}
                </p>
            </td>
            <td class="totals-sidebar">
                <table class="box-totals">
                    <tr><th>TRANSACCIÓN BRUTA (Gross)</th></tr>
                    <tr><td>$ {{ link.monto }}</td></tr>
                </table>
                <table class="box-totals">
                    <tr><th>DEDUCCIONES Y FEES (Total Fees)</th></tr>
                    <tr><td style="color: var(--grey); font-size: 11pt;">$ {{ link.commission_amount }}</td></tr>
                </table>
                <table class="box-totals saldo-accent">
                    <tr><th class="text-red">NETO PARA EL COMERCIO (Net Amount)</th></tr>
                    <tr><td class="text-red" style="font-size: 15pt;">$ {{ link.receiver_amount }}</td></tr>
                </table>
            </td>
        </tr>
    </table>

    <!-- TABLA DE LIQUIDACIÓN UNIFORME -->
    <table class="liq-table">
        <thead>
            <tr>
                <th width="32%">Operaciones del Gateway</th>
                <th width="15%">Monto Transaccion</th>
                <th width="35%">Cargos Administrativos</th>
                <th width="18%">Saldo Resultante</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="min-height: 240px;">
                    <span class="bold">ID OPERACIÓN: {{ link.order_id }}</span>
                    <p style="margin: 4px 0 0 0;">Liquidación PayZen N° {{ liq_nro }}</p>
                    <p style="margin: 2px 0;">Batch/Lote Lyra N° {{ lote_nro }}</p>
                    <p style="margin: 2px 0;">Referencia Trans.: {{ link.auth_code|default:"OK-REST" }}</p>
                    
                    <p class="bold" style="margin-top:12px; color: var(--grey);">
                        {% if link.cuotas_elegidas > 1 %}
                            MODO: PLAN {{ link.cuotas_elegidas }} CUOTAS (Emisor)
                        {% else %}
                            MODO: PAGO ÚNICO (One-Off)
                        {% endif %}
                    </p>
                </td>
                <td style="text-align: right; vertical-align: middle;">
                    <span class="bold">$ {{ link.monto }}</span>
                </td>
                <td>
                    <div class="desc-section">
                        <span class="bold">ø Comisiones Gateway</span><br>
                        - Fee Arancel Red de Pagos <span class="val-num">$ {{ desglose.arancel }}</span>
                    </div>

                    <div class="desc-section">
                        <span class="bold">ø Servicio de Liquidación</span><br>
                        - Servicio de Gestión Técnica <span class="val-num">$ {{ desglose.servicio }}</span><br>
                        {% if link.cuotas_elegidas > 1 %}
                            - Fee Costo Financiero (Plan {{ link.cuotas_elegidas }} p.) <span class="val-num">$ {{ desglose.costo_finan }}</span>
                            <span class="sub-text">(Unitario Cuota: $ {{ desglose.cuota_valor }})</span>
                        {% endif %}
                    </div>

                    <div class="desc-section" style="margin-bottom:0;">
                        <span class="bold">ø Cargas Impositivas</span><br>
                        I.V.A. Alícuota General (21%) <span class="val-num">$ {{ desglose.iva_21 }}</span><br>
                        {% if link.cuotas_elegidas > 1 %}
                            I.V.A. Financiación (10.5%) <span class="val-num">$ {{ desglose.iva_105 }}</span>
                        {% endif %}
                    </div>
                </td>
                <td style="background-color: #fff;"></td>
            </tr>

            <!-- FILA DE TOTALES CON LINEA NEGRA UNIFORME -->
            <tr class="total-row">
                <td style="border-top: 1.5px solid #000 !important;">TOTAL DE LA TRANSACCIÓN</td>
                <td style="text-align: right; border-top: 1.5px solid #000 !important;">$ {{ link.monto }}</td>
                <td style="text-align: right; font-size: 7.5pt; border-top: 1.5px solid #000 !important;">
                    RETENCIÓN TOTAL (Fees): <span style="font-size: 9pt;">$ {{ link.commission_amount }}</span>
                </td>
                <td style="text-align: right; color: var(--primary); font-size: 11pt; border-top: 1.5px solid var(--primary) !important; background: #fff;">
                    $ {{ link.receiver_amount }}
                </td>
            </tr>
        </tbody>
    </table>

    <!-- FOOTER TÉCNICO PAYZEN -->
    <table class="tax-footer">
        <tr>
            <td width="40%" style="border-right: 1px solid #ddd;">
                <p class="bold">MENSAJE TÉCNICO:</p>
                Comprobante electrónico de auditoría generado automáticamente por la pasarela de pagos REST API Lyra.
            </td>
            <td width="60%">
                <p class="bold" style="margin-bottom: 2px;">NOTIFICACIÓN COMERCIAL:</p>
                Los fondos serán conciliados y acreditados en su cuenta según los plazos establecidos por el procesador local PayZen by Lyra Argentina.
                <p style="font-size: 7pt; margin-top: 4px; color: var(--grey); font-style: italic;">
                    UUID PayZen: {{ link.nro_transaccion|default:"Captura Automática Sistema" }}
                </p>
            </td>
        </tr>
    </table>

    <table class="final-row">
        <tr>
            <td width="75%" style="color: var(--grey); font-size: 7pt; vertical-align: bottom;">
                RESUMEN DE LIQUIDACIÓN GENERADO POR PLATAFORMA PAGO TECH<br>
                Validación de ID PayZen: {{ link.nro_transaccion|default:"SYSTEM-CAPTURED" }}
            </td>
            <td class="qr-cell">
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=60x60&data=UUID-{{ link.nro_transaccion }}&color=e63946" width="55" alt="QR">
                <p style="font-size: 5.5pt; margin-top: 3px; font-weight: bold; color: var(--grey);">TRACKING LYRA</p>
            </td>
        </tr>
    </table>

    <div class="footer-brand">
        &copy; {% now "Y" %} | PAGO TECH | POWERED BY PAYZEN BY LYRA
    </div>

</body>
</html>